# 米国子会社向け見積書・請求書管理システム 設計書

## 1. システム概要

米国子会社が米国法人顧客に対して見積書と請求書を作成・管理するためのシステムです。見積書の作成から発注書の受領、請求書発行までを一貫して管理し、商品別契約期間に応じた収益計上ができる機能を実装します。また、各種書類のステータス管理と固有番号による管理を行います。

## 2. 業務要件定義

### 2.1 業務目的

- 米国子会社における見積書・請求書作成プロセスの効率化
- 発注書の受領管理と契約期間に応じた正確な収益計上の実現
- 各種文書のステータス管理による業務進捗の可視化
- 権限に基づいた適切な承認ワークフローの実現

### 2.2 業務範囲

- 見積書作成・管理
- 発注書受領・管理
- 請求書作成・管理
- 収益計上処理
- ユーザー管理・権限管理

### 2.3 主要ステークホルダー

- 営業担当者（見積書作成者）
- 経理担当者（請求書作成者）
- 管理者（承認者）
- 米国子会社経営層

## 3. データベース設計

### 3.1 ユーザーマスタ

| 項目 | 型 | 説明 |
|------|-----|------|
| ユーザーID | VARCHAR | 主キー |
| 氏名 | VARCHAR | |
| メールアドレス | VARCHAR | |
| 部署 | VARCHAR | |
| 役職 | VARCHAR | |
| 連絡先 | VARCHAR | |
| アカウントステータス | BOOLEAN | 有効/無効 |
| 最終ログイン日時 | DATETIME | |
| パスワード | VARCHAR | ハッシュ化して保存 |

#### 権限情報
- 見積書作成権限（boolean）
- 見積書承認権限（boolean）
- 発注書管理権限（boolean）
- 請求書作成権限（boolean）
- 請求書承認権限（boolean）
- 収益計上管理権限（boolean）
- ユーザー管理権限（boolean）

### 3.2 顧客マスタ

| 項目 | 型 | 説明 |
|------|-----|------|
| 顧客ID | VARCHAR | 主キー |
| 会社名 | VARCHAR | |
| 住所 | TEXT | 複数行、郵便番号、市区町村、州、国 |
| 電話番号 | VARCHAR | |
| メールアドレス | VARCHAR | |
| 担当者名 | VARCHAR | |
| 担当者部署 | VARCHAR | |
| 担当者連絡先 | VARCHAR | |
| Tax ID | VARCHAR | |
| VAT番号 | VARCHAR | |
| 支払い条件 | VARCHAR | Net30、Net60など |
| 顧客ステータス | VARCHAR | アクティブ/非アクティブ |
| 作成日時 | DATETIME | |
| 更新日時 | DATETIME | |

### 3.3 商品マスタ

| 項目 | 型 | 説明 |
|------|-----|------|
| 商品ID | VARCHAR | 主キー |
| 商品/サービスコード | VARCHAR | |
| 商品名/サービス名 | VARCHAR | |
| 説明 | TEXT | |
| 単価 | DECIMAL | |
| 税区分 | VARCHAR | |
| カテゴリ | VARCHAR | |
| 単位 | VARCHAR | 時間、個、セットなど |
| 収益計上方法 | VARCHAR | 一括/月次/日割り |
| 作成日時 | DATETIME | |
| 更新日時 | DATETIME | |

### 3.4 見積書マスタ

| 項目 | 型 | 説明 |
|------|-----|------|
| 見積書ID | VARCHAR | 主キー |
| 見積書番号 | VARCHAR | 自動採番、表示用：QT-YYYYMM-XXXX |
| 見積日 | DATE | |
| 有効期限 | DATE | |
| 顧客ID | VARCHAR | 外部キー |
| 合計金額（税抜） | DECIMAL | |
| 税額 | DECIMAL | |
| 合計金額（税込） | DECIMAL | |
| 見積書ステータス | VARCHAR | ドラフト/承認待ち/承認済み/発行済み/受注/失注/最終版/失効/削除済み |
| 作成者ID | VARCHAR | 外部キー |
| 承認者ID | VARCHAR | 外部キー |
| 承認日時 | DATETIME | |
| 備考 | TEXT | |
| 作成日時 | DATETIME | |
| 更新日時 | DATETIME | |

### 3.5 見積書明細

| 項目 | 型 | 説明 |
|------|-----|------|
| 明細ID | VARCHAR | 主キー |
| 見積書ID | VARCHAR | 外部キー |
| 商品ID | VARCHAR | 外部キー |
| 数量 | INTEGER | |
| 単価 | DECIMAL | |
| 金額（税抜） | DECIMAL | |
| 税率 | DECIMAL | |
| 税額 | DECIMAL | |
| 金額（税込） | DECIMAL | |
| 説明 | TEXT | オプション |
| 表示順序 | INTEGER | |

### 3.6 発注書マスタ

| 項目 | 型 | 説明 |
|------|-----|------|
| 発注書ID | VARCHAR | 主キー |
| 発注書番号 | VARCHAR | 顧客側番号、手動入力 |
| 発注日 | DATE | |
| 見積書ID | VARCHAR | 外部キー |
| 顧客ID | VARCHAR | 外部キー |
| 合計金額（税抜） | DECIMAL | |
| 税額 | DECIMAL | |
| 合計金額（税込） | DECIMAL | |
| 発注書ステータス | VARCHAR | 未受領/受領済み/処理中/完了 |
| 受領者ID | VARCHAR | 外部キー |
| 受領日時 | DATETIME | |
| 備考 | TEXT | |
| 作成日時 | DATETIME | |
| 更新日時 | DATETIME | |

### 3.7 発注書明細

| 項目 | 型 | 説明 |
|------|-----|------|
| 明細ID | VARCHAR | 主キー |
| 発注書ID | VARCHAR | 外部キー |
| 商品ID | VARCHAR | 外部キー |
| 数量 | INTEGER | |
| 単価 | DECIMAL | |
| 金額（税抜） | DECIMAL | |
| 税率 | DECIMAL | |
| 税額 | DECIMAL | |
| 金額（税込） | DECIMAL | |
| 契約開始日 | DATE | |
| 契約終了日 | DATE | |
| 説明 | TEXT | オプション |
| 表示順序 | INTEGER | |

### 3.8 請求書マスタ

| 項目 | 型 | 説明 |
|------|-----|------|
| 請求書ID | VARCHAR | 主キー |
| 請求書番号 | VARCHAR | 自動採番、表示用：INV-YYYYMM-XXXX |
| 請求日 | DATE | |
| 支払期限 | DATE | |
| 見積書ID | VARCHAR | 外部キー、NULL可 |
| 発注書ID | VARCHAR | 外部キー、NULL可 |
| 顧客ID | VARCHAR | 外部キー |
| 合計金額（税抜） | DECIMAL | |
| 税額 | DECIMAL | |
| 合計金額（税込） | DECIMAL | |
| 支払い状況 | VARCHAR | 未払い/一部支払い/支払い済み |
| 請求書ステータス | VARCHAR | ドラフト/承認待ち/承認済み/発行済み/入金済み |
| 作成者ID | VARCHAR | 外部キー |
| 承認者ID | VARCHAR | 外部キー |
| 承認日時 | DATETIME | |
| 銀行口座情報 | JSON | 銀行名/支店名/口座番号/口座名義/SWIFT/ABA/ルーティングコード |
| 作成日時 | DATETIME | |
| 更新日時 | DATETIME | |

### 3.9 請求書明細

| 項目 | 型 | 説明 |
|------|-----|------|
| 明細ID | VARCHAR | 主キー |
| 請求書ID | VARCHAR | 外部キー |
| 商品ID | VARCHAR | 外部キー |
| 発注書明細ID | VARCHAR | 外部キー、NULL可 |
| 数量 | INTEGER | |
| 単価 | DECIMAL | |
| 金額（税抜） | DECIMAL | |
| 税率 | DECIMAL | |
| 税額 | DECIMAL | |
| 金額（税込） | DECIMAL | |
| 請求対象期間（開始日） | DATE | |
| 請求対象期間（終了日） | DATE | |
| 説明 | TEXT | オプション |
| 表示順序 | INTEGER | |

### 3.10 収益計上スケジュール

| 項目 | 型 | 説明 |
|------|-----|------|
| スケジュールID | VARCHAR | 主キー |
| 発注書明細ID | VARCHAR | 外部キー |
| 計上年月 | DATE | |
| 開始日 | DATE | |
| 終了日 | DATE | |
| 日数 | INTEGER | |
| 計上金額 | DECIMAL | |
| 計上ステータス | VARCHAR | 未計上/計上済み |
| 計上日 | DATE | |
| 請求書ID | VARCHAR | 外部キー、NULL可 |
| 作成日時 | DATETIME | |
| 更新日時 | DATETIME | |

### 3.11 ロールマスタ

| 項目 | 型 | 説明 |
|------|-----|------|
| ロールID | VARCHAR | 主キー |
| ロール名 | VARCHAR | |
| 説明 | TEXT | |
| 見積書作成権限 | BOOLEAN | |
| 見積書承認権限 | BOOLEAN | |
| 発注書管理権限 | BOOLEAN | |
| 請求書作成権限 | BOOLEAN | |
| 請求書承認権限 | BOOLEAN | |
| 収益計上管理権限 | BOOLEAN | |
| ユーザー管理権限 | BOOLEAN | |
| 作成日時 | DATETIME | |
| 更新日時 | DATETIME | |

### 3.12 ユーザーロール連携

| 項目 | 型 | 説明 |
|------|-----|------|
| ユーザーID | VARCHAR | 外部キー |
| ロールID | VARCHAR | 外部キー |
| 付与日時 | DATETIME | |

### 3.13 月次集計のマテリアライズドビュー

| 項目 | 型 | 説明 |
|------|-----|------|
| year_month | CHAR(7) | 主キー |
| customer_id | VARCHAR(36) | 外部キー |
| total_amount | DECIMAL(15,2) | 合計金額 |
| invoice_count | INT | 請求書数 |
| last_updated | TIMESTAMP | 更新日時 |
| PRIMARY KEY (year_month, customer_id) | | |
| INDEX idx_summary_updated (last_updated) | | |

### 3.14 キャッシュテーブル

| 項目 | 型 | 説明 |
|------|-----|------|
| cache_key | VARCHAR(100) | 主キー |
| cache_value | JSON NOT NULL | |
| expires_at | TIMESTAMP NOT NULL | |
| created_at | TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP | |
| INDEX idx_cache_expires (expires_at) | | |

### 3.15 バッチ処理状態管理テーブル

| 項目 | 型 | 説明 |
|------|-----|------|
| job_id | VARCHAR(36) | 主キー |
| job_name | VARCHAR(100) | ジョブ名 |
| status | VARCHAR(20) | ステータス |
| start_time | TIMESTAMP | 開始時間 |
| end_time | TIMESTAMP | 終了時間 |
| error_message | TEXT | エラーメッセージ |
| created_at | TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新日時 |
| INDEX idx_job_status (status) | | |
| INDEX idx_job_created (created_at) | | |

### 3.16 エラーログテーブル

| 項目 | 型 | 説明 |
|------|-----|------|
| error_id | VARCHAR(36) | 主キー |
| error_type | VARCHAR(50) | エラータイプ |
| error_message | TEXT | エラーメッセージ |
| stack_trace | TEXT | スタックトレース |
| user_id | VARCHAR(36) | ユーザーID |
| entity_type | VARCHAR(50) | エンティティタイプ |
| entity_id | VARCHAR(36) | エンティティID |
| created_at | TIMESTAMP | 作成日時 |
| INDEX idx_error_type | | |
| INDEX idx_error_created | | |

### 3.17 監査ログテーブル

| 項目 | 型 | 説明 |
|------|-----|------|
| log_id | VARCHAR(36) | 主キー |
| entity_type | VARCHAR(50) | エンティティタイプ |
| entity_id | VARCHAR(36) | エンティティID |
| action_type | VARCHAR(20) | アクションタイプ |
| old_values | JSON | 変更前の値 |
| new_values | JSON | 変更後の値 |
| user_id | VARCHAR(36) | ユーザーID |
| ip_address | VARCHAR(45) | IPアドレス |
| created_at | TIMESTAMP | 作成日時 |
| INDEX idx_audit_entity | | |
| INDEX idx_audit_user | | |
| INDEX idx_audit_created | | |

## 4. 機能要件

### 4.1 ユーザー管理機能

#### ユーザー登録
- 必須情報：氏名、メールアドレス、部署、役職、連絡先
- ユーザー作成時に初期パスワードを自動生成
- 初回ログイン時にパスワード変更を強制

#### 権限管理
- 個別権限の設定
- 権限グループ（ロール）の作成・編集
- ユーザーへのロール割り当て

#### アクセス制御
- 権限に基づいたメニュー表示制御
- 権限のないページへのアクセス拒否
- 金額ベースの承認権限制限機能（オプション）

#### ユーザー活動ログ
- ログイン/ログアウト記録
- 重要な操作の記録
- ログの検索・フィルタリング機能

### 4.2 見積書管理機能

#### 見積書作成
- テンプレートベースの見積書作成
- 顧客マスタからの顧客情報取得
- 商品マスタからの商品情報取得
- 数量・単価入力による自動金額計算
- 税率設定と税額自動計算
- 備考欄の入力
- ドラフト保存機能
- 見積書番号の自動採番（QT-YYYYMM-XXXX形式）

#### 見積書承認ワークフロー
- 作成者から承認者への承認依頼
- 承認者による内容確認と承認/却下
- 承認/却下の理由記録
- 承認ステータスの追跡

#### 見積書ステータス管理
- ドラフト：作成中で未確定
- 承認待ち：承認依頼中
- 承認済み：内部承認完了
- 発行済み：顧客に送付済み
- 受注：発注書受領済み
- 失注：顧客に却下された見積書
- 最終版：請求書に変換済み
- 失効：有効期限切れ
- 削除済み：削除された見積書

#### 見積書検索・参照
- 見積書番号、顧客名、日付、ステータスによる検索
- 見積書一覧表示と詳細表示
- 見積書の印刷・PDF出力
- メール送信機能

### 4.3 発注書管理機能

#### 発注書受領登録
- 顧客から受領した発注書の登録
- 発注書のスキャン画像またはPDFアップロード
- 発注書番号の手動入力
- 見積書との紐付け
- 発注書内容の入力

#### 商品別契約期間管理
- 発注書明細ごとの契約開始日・終了日の設定
- 契約期間に基づく収益計上スケジュールの自動生成
- 契約期間の変更に伴うスケジュール再計算

#### 発注書ステータス管理
- 未受領：発注書が未到着
- 受領済み：発注書を受領
- 処理中：請求書作成中
- 完了：全ての処理が完了

#### 発注書検索・参照
- 発注書番号、見積書番号、顧客名、日付、ステータスによる検索
- 発注書一覧表示と詳細表示
- 発注書の印刷・PDF出力機能

### 4.4 請求書管理機能

#### 見積書/発注書からの請求書作成
- 承認済み見積書または受領済み発注書を選択して請求書に変換
- 見積書/発注書の内容を自動的に請求書にコピー
- 見積書/発注書番号の請求書への自動記載
- 見積書ステータスの自動更新（最終版に変更）
- 発注書の契約期間に基づく請求対象期間の自動設定

#### 請求書直接作成
- 見積書/発注書なしでの請求書作成
- 顧客マスタからの顧客情報取得
- 商品マスタからの商品情報取得
- 数量・単価入力による自動金額計算
- 税率設定と税額自動計算
- 銀行口座情報の自動表示
- 請求書番号の自動採番（INV-YYYYMM-XXXX形式）

#### 請求書承認ワークフロー
- 作成者から承認者への承認依頼
- 承認者による内容確認と承認/却下
- 承認/却下の理由記録
- 承認ステータスの追跡

#### 請求書ステータス管理
- ドラフト：作成中で未確定
- 承認待ち：承認依頼中
- 承認済み：内部承認完了
- 発行済み：顧客に送付済み
- 入金済み：支払い確認済み

#### 支払い管理
- 支払い記録機能
- 部分支払い対応
- 支払い方法の記録
- 未払い/延滞請求書の管理

#### 請求書検索・参照
- 請求書番号、見積書番号、発注書番号、顧客名、日付、ステータスによる検索
- 請求書一覧表示と詳細表示
- 請求書の印刷・PDF出力
- メール送信機能

### 4.5 収益計上機能

#### 収益計上スケジュール管理
- 発注書の商品別契約期間に基づく収益計上スケジュールの自動生成
- 日割り計算による月次収益計上金額算出
- 収益計上スケジュールの表示・編集
- 契約変更に伴うスケジュール再計算

#### 収益計上処理
- 月次収益計上の実行
- 収益計上ステータスの更新
- 収益計上履歴の管理
- 会計システムへのデータ連携

#### 収益計上レポート
- 期間別収益計上予定
- 顧客別収益計上状況
- 商品別収益計上状況
- 未計上収益の管理

### 4.6 マスタデータ管理

#### 顧客マスタ管理
- 顧客情報の登録・編集・無効化
- 顧客情報の一覧表示と検索
- 顧客ごとの取引履歴参照

#### 商品マスタ管理
- 商品/サービス情報の登録・編集・無効化
- 商品情報の一覧表示と検索
- 価格改定履歴

### 4.7 レポート機能

#### 見積書レポート
- 期間別見積書一覧
- 顧客別見積書一覧
- ステータス別見積書集計

#### 発注書レポート
- 期間別発注書一覧
- 顧客別発注書一覧
- 受領状況レポート

#### 請求書レポート
- 期間別請求書一覧
- 顧客別請求書一覧
- 支払い状況レポート
- 売上レポート

#### 収益計上レポート
- 月次収益計上実績
- 将来収益計上予測
- 商品別収益計上分析

#### ユーザー活動レポート
- ユーザー別操作履歴
- 承認プロセス所要時間分析

#### データエクスポート
- CSV/Excel形式でのデータエクスポート
- カスタムレポート作成

## 5. 業務フロー定義

### 5.1 見積書作成フロー

1. 営業担当者が見積書をドラフト作成
2. 顧客情報と商品情報を入力
3. 見積書番号を自動採番（QT-YYYYMM-XXXX）
4. 金額計算を自動実行
5. 承認者に承認依頼を送信（ステータス：承認待ち）
6. 承認者が内容を確認し承認または差戻し
7. 承認後、見積書をPDF生成し顧客に送付（ステータス：発行済み）
8. 顧客からの回答により、ステータスを「受注」または「失注」に更新

### 5.2 発注書受領フロー

1. 顧客から発注書を受領
2. 営業担当者が発注書情報をシステムに登録
3. 発注書番号を手動入力
4. 対応する見積書と紐付け
5. 商品別の契約期間（開始日・終了日）を入力
6. 契約期間に基づき収益計上スケジュールを自動生成
7. 発注書ステータスを「受領済み」に更新
8. 見積ステータスを「受注」に更新
9. 請求書作成プロセスへの移行を通知

### 5.3 請求書作成フロー

1. 経理担当者が請求書をドラフト作成
2. 見積書または発注書から請求書を自動生成
3. 発注書の契約期間に基づき請求対象期間を設定
4. 請求書番号を自動採番（INV-YYYYMM-XXXX）
5. 承認者に承認依頼を送信（ステータス：承認待ち）
6. 承認者が内容を確認し承認または差戻し
7. 承認後、請求書をPDF生成し顧客に送付（ステータス：発行済み）
8. 入金確認後、ステータスを「入金済み」に更新

### 5.4 収益計上フロー

1. 発注書の商品別契約期間に基づき収益計上スケジュールを自動生成
2. 契約開始日から終了日までの日数を算出
3. 商品金額を日割り計算し月次で収益計上スケジュールを作成
4. 月次で収益計上処理を実行
5. 収益計上データを会計システムに連携
6. 収益計上ステータスを「計上済み」に更新

### 5.5 入金管理フロー

1. 入金情報を登録
2. 対応する請求書と紐付け
3. 請求ステータスを「入金済み」に更新
4. 入金確認レポートを生成

## 6. 技術要件

### 6.1 セキュリティ

#### 認証・認可
- セキュアなログイン処理
- パスワードの安全な保存（ハッシュ化）
- セッション管理
- 権限に基づいたアクセス制御

#### データ保護
- 通信の暗号化（HTTPS）
- 銀行口座情報などの機密データの暗号化
- バックアップ機能

### 6.2 ユーザーインターフェース

#### 基本UI
- 直感的な操作画面
- レスポンシブデザイン
- ダッシュボード表示（未承認見積書/請求書、期限切れ見積書など）

#### 見積書/発注書/請求書画面
- フォーム入力の効率化（自動計算、入力補助）
- プレビュー機能
- ドラッグ&ドロップによる商品追加
- 権限に基づいた表示制御

### 6.3 システム連携

#### データインポート/エクスポート
- CSV/Excelでのデータインポート
- レポートのエクスポート
- APIによる外部システム連携
- 会計システムとの連携

## 7. 画面一覧

### ログイン画面
### ダッシュボード

### ユーザー管理
- ユーザー一覧
- ユーザー作成/編集
- ロール管理

### 顧客管理
- 顧客一覧
- 顧客作成/編集
- 顧客詳細

### 商品管理
- 商品一覧
- 商品作成/編集

### 見積書管理
- 見積書一覧
- 見積書作成/編集
- 見積書詳細
- 見積書承認

### 発注書管理
- 発注書一覧
- 発注書登録/編集
- 発注書詳細
- 収益計上スケジュール

### 請求書管理
- 請求書一覧
- 請求書作成/編集
- 請求書詳細
- 請求書承認
- 支払い記録

### 収益計上管理
- 収益計上スケジュール一覧
- 収益計上実行
- 収益計上履歴

### レポート
- 見積書レポート
- 発注書レポート
- 請求書レポート
- 収益計上レポート
- ユーザー活動レポート

## 8. 開発優先度

1. ユーザー認証・権限管理
2. マスタデータ管理（顧客・商品）
3. 見積書作成・管理
4. 発注書受領・管理
5. 請求書作成・管理
6. 見積書/発注書から請求書への変換
7. 収益計上管理
8. レポート機能 

## 9. システム要件定義（詳細）

### 9.1 システムアーキテクチャ

#### 9.1.1 全体アーキテクチャ
- 3層アーキテクチャ採用（プレゼンテーション層、ビジネスロジック層、データアクセス層）
- Webアプリケーションとして実装
- RESTful APIによるバックエンド・フロントエンド分離

#### 9.1.2 開発・実行環境
- フロントエンド：HTML5, CSS3, JavaScript (React.js)
- バックエンド：Node.js, Express.js (または代替として Java, Spring Boot)
- データベース：PostgreSQL (または MySQL)
- 認証：OAuth 2.0, JWT
- ホスティング：AWS (または Azure, GCP)

### 9.2 詳細機能要件

#### 9.2.1 認証・認可機能詳細

| 機能ID | 機能名 | 詳細説明 |
|--------|--------|----------|
| AUTH-01 | ユーザーログイン | メールアドレス・パスワードによる認証、多要素認証オプション対応 |
| AUTH-02 | パスワードリセット | メールリンクによるパスワードリセット機能 |
| AUTH-03 | セッション管理 | JWT有効期限設定（60分）、リフレッシュトークン（30日） |
| AUTH-04 | 権限チェック | APIアクセス時の権限確認（JWT内の権限情報を検証） |
| AUTH-05 | 権限管理 | ロールベースおよび個別権限設定機能 |
| AUTH-06 | ログイン履歴 | 日時、IPアドレス、デバイス情報の記録 |

### 9.3 詳細非機能要件

#### 9.3.1 パフォーマンス要件
- 画面レスポンス：通常操作で2秒以内、レポート生成で5秒以内
- 同時接続ユーザー：最大50名
- バッチ処理：夜間バッチは3時間以内に完了
- データ処理容量：年間10,000件の見積書・請求書処理に対応
- ストレージ：初期5GB、年間成長率30%を想定

#### 9.3.2 可用性要件
- 稼働時間：24時間365日
- 計画メンテナンス：月1回、深夜1時から3時
- 年間稼働率：99.5%以上（計画メンテナンス除く）
- 障害復旧時間：重大障害は4時間以内、軽微障害は24時間以内

#### 9.3.3 セキュリティ要件
- データ通信暗号化：TLS 1.2以上
- パスワード要件：8文字以上、大小文字・数字・特殊文字を含む
- パスワード有効期限：90日
- ログイン試行制限：5回失敗でアカウントロック
- データバックアップ：日次増分、週次完全バックアップ
- 脆弱性スキャン：四半期ごとに実施
- データ暗号化：機密情報はDB内で暗号化保存

## 10. 移行計画

### 10.1 データ移行計画
1. **移行対象データの特定**
   - 顧客データ
   - 商品データ
   - 過去の見積書・請求書データ
   - 未収入金データ

2. **データクレンジング**
   - 既存データの精査（重複、欠損、不整合の確認）
   - データ形式の標準化
   - マスターデータの整備

## 11. 開発・導入スケジュール

### 11.1 フェーズ分け
1. **フェーズ1（基盤構築）** - 2か月
   - システム基盤構築
   - ユーザー管理・マスタデータ管理
   - 見積書基本機能

2. **フェーズ2（基本機能）** - 2か月
   - 発注書管理
   - 請求書基本機能
   - 承認ワークフロー

3. **フェーズ3（機能拡張）** - 2か月
   - 収益計上機能の実装
   - レポート機能の強化
   - システムの最適化

4. **フェーズ4（テスト・検証）** - 1か月
   - システムのテスト
   - ユーザーの受け入れテスト
   - システムの検証

5. **フェーズ5（導入・運用）** - 2か月
   - システムの導入
   - ユーザーの教育
   - システムの運用

6. **フェーズ6（継続的改善）** - 以降
   - ユーザーのフィードバックに基づく改善
   - 新機能の追加
   - システムの継続的な改善 

-- 行レベルセキュリティの実装
CREATE VIEW secure_invoices AS
SELECT 
    i.*,
    CASE 
        WHEN u.department = 'Finance' THEN i.total_amount
        ELSE NULL
    END AS masked_amount
FROM 
    invoices i
    JOIN users u ON i.created_by = u.user_id
WHERE 
    u.user_id = CURRENT_USER()
    OR EXISTS (
        SELECT 1 FROM user_roles ur 
        JOIN roles r ON ur.role_id = r.role_id 
        WHERE ur.user_id = CURRENT_USER() 
        AND r.name = 'Finance_Manager'
    ); 

-- 機密データのマスキング関数
DELIMITER //
CREATE FUNCTION mask_sensitive_data(p_data VARCHAR(255))
RETURNS VARCHAR(255)
DETERMINISTIC
BEGIN
    RETURN CONCAT(
        LEFT(p_data, 4),
        REPEAT('*', LENGTH(p_data) - 8),
        RIGHT(p_data, 4)
    );
END //
DELIMITER ; 

-- バッチ処理状態管理テーブルの追加
CREATE TABLE batch_jobs (
    job_id VARCHAR(36) PRIMARY KEY,
    job_name VARCHAR(100) NOT NULL,
    status VARCHAR(20) NOT NULL,
    start_time TIMESTAMP,
    end_time TIMESTAMP,
    error_message TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_job_status (status),
    INDEX idx_job_created (created_at)
); 

-- エラーログテーブルの追加
CREATE TABLE error_logs (
    error_id VARCHAR(36) PRIMARY KEY,
    error_type VARCHAR(50) NOT NULL,
    error_message TEXT NOT NULL,
    stack_trace TEXT,
    user_id VARCHAR(36),
    entity_type VARCHAR(50),
    entity_id VARCHAR(36),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_error_type (error_type),
    INDEX idx_error_created (created_at)
); 

-- 監査ログテーブルの追加
CREATE TABLE audit_logs (
    log_id VARCHAR(36) PRIMARY KEY,
    entity_type VARCHAR(50) NOT NULL,
    entity_id VARCHAR(36) NOT NULL,
    action_type VARCHAR(20) NOT NULL,
    old_values JSON,
    new_values JSON,
    user_id VARCHAR(36) NOT NULL,
    ip_address VARCHAR(45),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_audit_entity (entity_type, entity_id),
    INDEX idx_audit_user (user_id),
    INDEX idx_audit_created (created_at)
); 